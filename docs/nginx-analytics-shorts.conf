# Nginx config for analytics-shorts.nm2tech-sas.com
# Place in: /etc/nginx/conf.d/analytics-shorts.conf
#
# Important:
# - X-Frame-Options SAMEORIGIN allows the post page to embed the shared dashboard in an iframe.
#   You must set this in BOTH the HTTP (80) and HTTPS (443) server blocks.
# - try_files with /index.html ensures SPA routes (e.g. /post/xxx) return the app instead of 404.
#
# For HTTPS: run once: sudo certbot --nginx -d analytics-shorts.nm2tech-sas.com
# Certbot may add a listen 443 block; if so, add the add_header line inside that block too.

server {
    listen 80;
    server_name analytics-shorts.nm2tech-sas.com;
    root /var/www/analytics-shorts;
    index index.html;
    add_header X-Frame-Options "SAMEORIGIN" always;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://127.0.0.1:5000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# If you serve over HTTPS, duplicate the logic in a listen 443 block and add the same add_header.
# Example (cert paths from certbot):
# server {
#     listen 443 ssl;
#     server_name analytics-shorts.nm2tech-sas.com;
#     root /var/www/analytics-shorts;
#     index index.html;
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     ssl_certificate /etc/letsencrypt/live/analytics-shorts.nm2tech-sas.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/analytics-shorts.nm2tech-sas.com/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#     location / { try_files $uri $uri/ /index.html; }
#     location /api { ... same proxy_pass as above ... }
# }
